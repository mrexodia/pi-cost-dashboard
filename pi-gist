#!/bin/bash
# Pi Transcript Gist Publisher
# Export Pi session transcripts to HTML and publish to GitHub Gist
# Inspired by: https://simonwillison.net/2025/Dec/25/claude-code-transcripts/

set -e

VERSION="1.0.0"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Print colored output (all to stderr to avoid polluting command substitution)
print_error() { echo -e "${RED}✗${NC} $1" >&2; }
print_success() { echo -e "${GREEN}✓${NC} $1" >&2; }
print_info() { echo -e "${BLUE}ℹ${NC} $1" >&2; }
print_warning() { echo -e "${YELLOW}⚠${NC} $1" >&2; }

# Show help
show_help() {
    cat << 'EOF'
Pi Transcript Gist Publisher

Export Pi session transcripts to HTML and publish to GitHub Gist.

USAGE:
    pi-gist [OPTIONS] [FILE]

OPTIONS:
    -h, --help              Show this help
    -v, --version           Show version
    -o, --output FILE       Output HTML file (default: temp file or <session>.html)
    -g, --gist              Publish to GitHub Gist
    --open                  Open in browser
    -i, --interactive       Interactive session picker
    -l, --limit N           Limit interactive picker to N sessions (default: 10)
    --install               Install to /usr/local/bin
    --setup-alias           Add shell alias

EXAMPLES:
    # Export and publish to gist
    pi-gist session.jsonl --gist --open

    # Interactive picker
    pi-gist --interactive --gist

    # Just export locally
    pi-gist session.jsonl -o output.html

    # Export latest session
    pi-gist $(ls -t *.jsonl | head -1) --gist --open

REQUIREMENTS:
    - Pi installed
    - GitHub CLI (gh) for gist publishing:
      brew install gh && gh auth login

NOTES:
    Pi already has built-in HTML export via: pi --export
    This script adds GitHub Gist publishing and convenience features.

EOF
}

# Interactive session picker
interactive_picker() {
    local limit=${1:-10}
    
    print_info "Finding Pi sessions in current directory..."
    
    # Find JSONL files
    local sessions=$(find . -maxdepth 1 -name "*.jsonl" -type f 2>/dev/null | sort -r | head -n "$limit")
    
    if [ -z "$sessions" ]; then
        print_error "No JSONL session files found in current directory."
        echo ""
        echo "Tip: Pi sessions are typically stored in:"
        echo "  ~/.pi/agent/sessions/*/*.jsonl"
        exit 1
    fi
    
    # Build menu
    echo ""
    echo "Found $(echo "$sessions" | wc -l | tr -d ' ') session(s):"
    echo ""
    
    local counter=1
    declare -gA session_map
    
    while IFS= read -r session; do
        # Get file info
        local filename=$(basename "$session")
        local size=$(ls -lh "$session" | awk '{print $5}')
        local date=$(stat -f "%Sm" -t "%Y-%m-%d %H:%M" "$session" 2>/dev/null || stat -c "%y" "$session" 2>/dev/null | cut -d'.' -f1)
        
        # Try to get first user message as preview
        local preview=$(head -100 "$session" | grep -m 1 '"role":"user"' | sed 's/.*"text":"\([^"]*\)".*/\1/' | cut -c1-60)
        if [ -z "$preview" ]; then
            preview="(no preview)"
        fi
        
        session_map[$counter]="$session"
        printf "%2d) %s  %6s  %s\n" "$counter" "$date" "$size" "$preview"
        counter=$((counter + 1))
    done <<< "$sessions"
    
    echo ""
    read -p "Select session (1-$((counter-1)), or q to quit): " choice
    
    if [ "$choice" = "q" ] || [ "$choice" = "Q" ]; then
        echo "Cancelled."
        exit 0
    fi
    
    # Validate choice
    if ! [[ "$choice" =~ ^[0-9]+$ ]] || [ "$choice" -lt 1 ] || [ "$choice" -ge "$counter" ]; then
        print_error "Invalid selection."
        exit 1
    fi
    
    echo "${session_map[$choice]}"
}

# Export session to HTML using Pi
export_html() {
    local input_file="$1"
    local output_file="$2"
    
    if [ ! -f "$input_file" ]; then
        print_error "File not found: $input_file"
        exit 1
    fi
    
    print_info "Exporting session to HTML..."
    
    pi --export "$input_file" "$output_file"
    if [ $? -ne 0 ]; then
        print_error "Failed to export session"
        exit 1
    fi
    
    print_success "Exported to: $output_file"
}

# Publish HTML to GitHub Gist
publish_gist() {
    local html_file="$1"
    
    if [ ! -f "$html_file" ]; then
        print_error "HTML file not found: $html_file"
        exit 1
    fi
    
    # Check if gh is installed
    if ! command -v gh &> /dev/null; then
        print_error "GitHub CLI (gh) is not installed"
        echo "" >&2
        echo "Install with: brew install gh" >&2
        echo "Then authenticate: gh auth login" >&2
        exit 1
    fi
    
    print_info "Publishing to GitHub Gist..."
    
    local gist_output
    if ! gist_output=$(gh gist create "$html_file" --public 2>&1); then
        print_error "Failed to create gist"
        echo "$gist_output" >&2
        exit 1
    fi
    
    # Extract gist URL
    local gist_url=$(echo "$gist_output" | grep -o 'https://gist.github.com/[^[:space:]]*' | head -1)
    local gist_id=$(echo "$gist_url" | awk -F/ '{print $NF}')
    local filename=$(basename "$html_file")
    local preview_url="https://gistpreview.github.io/?${gist_id}/${filename}"
    
    print_success "Published to gist!"
    echo "" >&2
    echo "Gist URL: $gist_url" >&2
    echo "Preview URL: $preview_url" >&2
    echo "" >&2
    
    echo "$preview_url"
}

# Open URL in browser
open_browser() {
    local url="$1"
    
    if [[ "$url" == http* ]]; then
        print_info "Opening in browser..."
        if ! open "$url" 2>/dev/null && ! xdg-open "$url" 2>/dev/null; then
            print_warning "Could not open browser automatically."
            echo "Please open: $url" >&2
        fi
    else
        print_info "Opening in browser..."
        local full_path="file://$(cd "$(dirname "$url")" && pwd)/$(basename "$url")"
        if ! open "$full_path" 2>/dev/null && ! xdg-open "$full_path" 2>/dev/null; then
            print_warning "Could not open browser automatically."
            echo "Please open: $full_path" >&2
        fi
    fi
}

# Install script to /usr/local/bin
install_script() {
    local script_path="$(cd "$(dirname "$0")" && pwd)/$(basename "$0")"
    local install_path="/usr/local/bin/pi-gist"
    
    if [ -f "$install_path" ]; then
        read -p "pi-gist is already installed. Overwrite? (y/n): " -n 1 -r
        echo
        if [[ ! $REPLY =~ ^[Yy]$ ]]; then
            echo "Cancelled."
            exit 0
        fi
    fi
    
    print_info "Installing to $install_path..."
    
    if ! sudo cp "$script_path" "$install_path" 2>/dev/null; then
        print_error "Installation failed. Try running with sudo."
        exit 1
    fi
    
    if ! sudo chmod +x "$install_path" 2>/dev/null; then
        print_error "Failed to make executable."
        exit 1
    fi
    
    print_success "Installed successfully!"
    echo ""
    echo "You can now use: pi-gist"
}

# Setup shell alias
setup_alias() {
    local script_path="$(cd "$(dirname "$0")" && pwd)/$(basename "$0")"
    
    # Detect shell
    if [ -n "$ZSH_VERSION" ]; then
        SHELL_RC="$HOME/.zshrc"
    elif [ -n "$BASH_VERSION" ]; then
        SHELL_RC="$HOME/.bashrc"
    else
        print_error "Could not detect shell type."
        exit 1
    fi
    
    # Check if alias already exists
    if grep -q "alias pi-gist=" "$SHELL_RC" 2>/dev/null; then
        print_warning "Alias already exists in $SHELL_RC"
        read -p "Overwrite? (y/n): " -n 1 -r
        echo
        if [[ ! $REPLY =~ ^[Yy]$ ]]; then
            echo "Cancelled."
            exit 0
        fi
        sed -i.bak '/alias pi-gist=/d' "$SHELL_RC"
    fi
    
    echo "alias pi-gist='$script_path'" >> "$SHELL_RC"
    
    print_success "Alias added to $SHELL_RC"
    echo ""
    echo "To use it now, run:"
    echo "  source $SHELL_RC"
    echo ""
    echo "Or open a new terminal window."
}

# Main function
main() {
    local input_file=""
    local output_file=""
    local publish_to_gist=false
    local open_in_browser=false
    local interactive=false
    local limit=10
    
    # Parse arguments
    while [[ $# -gt 0 ]]; do
        case $1 in
            -h|--help)
                show_help
                exit 0
                ;;
            -v|--version)
                echo "pi-gist version $VERSION"
                exit 0
                ;;
            -o|--output)
                output_file="$2"
                shift 2
                ;;
            -g|--gist)
                publish_to_gist=true
                shift
                ;;
            --open)
                open_in_browser=true
                shift
                ;;
            -i|--interactive)
                interactive=true
                shift
                ;;
            -l|--limit)
                limit="$2"
                shift 2
                ;;
            --install)
                install_script
                exit 0
                ;;
            --setup-alias)
                setup_alias
                exit 0
                ;;
            -*)
                print_error "Unknown option: $1"
                echo "Use --help for usage information."
                exit 1
                ;;
            *)
                if [ -z "$input_file" ]; then
                    input_file="$1"
                fi
                shift
                ;;
        esac
    done
    
    # Interactive mode
    if [ "$interactive" = true ]; then
        input_file=$(interactive_picker "$limit")
        if [ -z "$input_file" ]; then
            exit 1
        fi
        echo ""
        print_info "Selected: $(basename "$input_file")"
        echo ""
    fi
    
    # Validate input file
    if [ -z "$input_file" ]; then
        print_error "No input file specified"
        echo ""
        echo "Usage: pi-gist [OPTIONS] FILE"
        echo "Use --help for more information."
        exit 1
    fi
    
    # Determine output filename
    if [ -z "$output_file" ]; then
        local basename=$(basename "$input_file" .jsonl)
        if [ "$publish_to_gist" = true ]; then
            output_file=$(mktemp).html
        else
            output_file="${basename}.html"
        fi
    fi
    
    # Export to HTML
    export_html "$input_file" "$output_file"
    
    # Publish to gist if requested
    local result_url=""
    if [ "$publish_to_gist" = true ]; then
        echo ""
        result_url=$(publish_gist "$output_file")
    else
        result_url="$output_file"
    fi
    
    # Open in browser if requested
    if [ "$open_in_browser" = true ]; then
        echo ""
        open_browser "$result_url"
    fi
    
    echo ""
    print_success "Done!"
}

# Run main function
main "$@"
